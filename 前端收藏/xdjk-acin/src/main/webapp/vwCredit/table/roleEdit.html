<!DOCTYPE html>
<html lang="zh">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> 
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>角色管理</title>
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="css/htmleaf-demo.css">
	<link rel="stylesheet" href="css/samples-styles.css">
	<link rel="stylesheet" href="css/ctsi.css">
	<style type="text/css">
		td.alt { background-color: #ffc; background-color: rgba(230, 127, 34, 0.2); }
	</style>
</head>
<body>
	<script type="text/javascript">
        var area_id;
        var parent_id;
        var role_number;

        //下拉框的数据，股票代码/股票名称
        var initlist = new Array();//

		//模糊查询input
        var fuzzysearchinput = document.getElementById("fuzzysearch");

        //选中的股票代码（需要传到后台的参数）
        var selectedlist = new Array();
        //选中的股票名称（展示在前台给业务员看的）
        var selectednamelist =  new Array();
	</script>
	<div class="htmleaf-container">
		<div class="htmleaf-content">
			<br>
			<table class="userTable" width="100%">
				<thead>
					<tr>
			                <th scope="col">分行地区</th>
							<th scope="col">角色等级</th>
			                <th scope="col">菜单</th>
							<th scope="col">操作</th>
			            </tr>
				</thead>
				<tbody>

				</tbody>
			</table>

		</div>

	</div>
	
	<script>window.jQuery || document.write('<script src="js/jquery-1.11.0.min.js"><\/script>')</script>
	<script src="js/jquery.filtertable.min.js"></script>
	<script>
	    $(document).ready(function() {
	        $('table').filterTable({ // apply filterTable to all tables on this page
	            inputSelector: '#input-filter' // use the existing input instead of creating a new one
	        });
	    });
	</script>
</body>
</html>
<script>
	$(function () {
        var url = window.location.href;
        var id=decodeURI(url.substring(url.indexOf('=')+1,url.length));
        var list=new Array();
        list=id.split("|");
        console.log(list);
         area_id=list[0];
         parent_id=list[1];
         role_number=list[2];
        var params={"area_id":area_id,"parent_id":parent_id};
        var area=list[3];
        var role=list[4];
        $.ajax({
            url: "/role/getRoleMenuList",
            contentType: "application/json;charset=UTF-8",
            data:JSON.stringify(params),
            dataType:"json",
            type: "POST",
            success: function(data){
                console.log(data);
                var menuId=getMenuList(data.data);
                var menuName=getMenuNameList(data.data);
                prepareMenuList(menuId,menuName);
                $('.userTable').append( " <tr>\n" +
                    "<td>"+area+"</td>\n" +
                    "<td>"+role+"</td>\n" +
                    "<td>" +
						"    <div style=\"width:100%;height:100%;overflow:hidden;\">\n" +
						"        <input type=\"text\" id=\"selectButton\" onclick=\"myclick();\" readonly=\"true\" style=\"width:200px;height:20px;\">\n" +
						"    </div>\n" +

						"    <div id=\"selectdiv\" style=\"display:none;border:1px solid #A9A9A9;width:200px;z-index:2;position:absolute;overflow-y :scroll;height:200px;background-color:white;\"\n" +
						"         onMouseOver=\"mousein()\" onMouseOut=\"mouseout()\">\n" +
						"        <br>\n" +
						"    </div>\n" +
						"    <br>\n" +
                    "</td>" +
                    "<td><button onclick='powerSubmit()'>确定</button></td>\n" +
                    "</tr>");

                prepare();
            },
            error : function(e) {
                alert("error !");
                alert(e);
            }
        })



    })
	function getMenuList(data) {
        var menuId =new Array();
        for(var i=0;i<data.length;i++){
            menuId[i]=data[i].id;
        }
        return menuId;
	}
    function getMenuNameList(data) {
        var menuName =new Array();
        for(var i=0;i<data.length;i++){
            menuName[i]=data[i].menu_name;
        }
        return menuName;
    }
    function prepareMenuList(id,name) {
        for(var i=0;i<id.length;i++){
            initlist.push(id[i]+"/"+name[i]);
        }
    }
    function powerSubmit() {
	    var params=area_id+"|"+role_number+"|"+selectedlist;
	    console.log(params);
        $.ajax({
            url: "/role/setAreaRoleMenu",
            contentType: "application/json;charset=UTF-8",
            data:params,
            dataType:"text",
            type: "POST",
            success: function(data){
                alert("修改成功");
            },
            error : function(e) {
                alert("error !");
            }
        })
    }
</script>
<script>
	function prepare(){

        //多选下拉框所在的div
        var selecteddiv = document.getElementById("selectdiv");

        //鼠标是否在【多选下拉框div】上面（如果在div上面，需要控制鼠标的点击事件，不让div隐藏；否则要让该div隐藏）
        var indiv = false;



            //动态创建所有的checkbox元素
            for(var i = 0; i < initlist.length; i++){
                var tmpdiv = document.createElement("div");
                var tmpinput = document.createElement("input");
                tmpinput.setAttribute("name","mycheckbox");
                tmpinput.setAttribute("type","checkbox");
                tmpinput.setAttribute("onclick","mycheck(this)");
                tmpinput.setAttribute("value",initlist[i].substr(0,initlist[i].indexOf("/")));

                var tmptext = document.createTextNode(initlist[i].substr(initlist[i].indexOf("/")+1,initlist[i].length));
                tmpdiv.appendChild(tmpinput);
                tmpdiv.appendChild(tmptext);
                selecteddiv.appendChild(tmpdiv);
            }

            //鼠标点击事件，如果点击在 selectedbutton，或者是在多选框div中的点击事件，不作处理。其他情况的点击事件，将多选空div隐藏
            document.onclick=function(event){
                if(event.target.id=="selectButton" || indiv){
                    return;
                }
                // $('#selectdiv').css("display","none");
            };

	}
    //点击selectButton，展示多选框
    function myclick (){
        $('#selectdiv').css("display","block");
    }

    //鼠标进入多选框的div【selectdiv】
    function mousein(){
        indiv = true;
    }

    //鼠标离开多选框的div【selectdiv】
    function  mouseout(){
        indiv = false;
    }

    //checkbox的点击事件
    function mycheck(obj){
        if(obj.checked){
            console.log(obj.nextSibling.nodeValue);
            selectedlist.push(obj.value);
            selectednamelist.push(obj.nextSibling.nodeValue);
        }else{
            for(var i = 0; i < selectedlist.length; i++){
                if(selectedlist[i] == obj.value){
                    selectedlist.splice(i,1);
                    selectednamelist.splice(i,1);
                }
            }
        }
        document.getElementById("selectButton").value=selectednamelist;
    }

    //模糊查询
    function myfuzzysearch(){
        var checkboxlist = document.getElementsByName("mycheckbox");
        for(var i = 0; i < checkboxlist.length; i++){
            if(checkboxlist[i].nextSibling.nodeValue.indexOf(fuzzysearchinput.value) == -1){
                checkboxlist[i].parentNode.style.display = "none";
            }else{
                checkboxlist[i].parentNode.style.display = "block";
            }
        }
    }

    function mysubmit(){
        alert(selectedlist);
    }
</script>

